var theia_waffle_nano_burn=function(e){var t={};function r(a){if(t[a])return t[a].exports;var i=t[a]={i:a,l:!1,exports:{}};return e[a].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(a,i,function(t){return e[t]}.bind(null,i));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t){e.exports=theia.theia_waffle_nano_burn},function(e,t){e.exports=wm.theia_waffle_nano_burn},function(e,t,r){"use strict";var a=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))((function(i,n){function o(e){try{l(a.next(e))}catch(e){n(e)}}function s(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.stop=t.start=void 0;const i=r(0),n=r(1),o=r(3),s={id:"waffle.nano.burn.upload",label:"waffle nano:upload"},l={id:"waffle.nano.burn.break",label:"waffle nano:break"},d=new o.Hiburn;t.start=function(e){e.subscriptions.push(i.commands.registerCommand(s,(...e)=>a(this,void 0,void 0,(function*(){var t;if((null===(t=e[0])||void 0===t?void 0:t.fsPath)&&n.webserial.connected()){let t=i.Uri.parse(e[0].fsPath);yield d.uploadFirmware(t,921600)}})))),e.subscriptions.push(i.commands.registerCommand(l,(...e)=>a(this,void 0,void 0,(function*(){d.setBreak()}))))},t.stop=function(){}},function(e,t,r){"use strict";var a=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))((function(i,n){function o(e){try{l(a.next(e))}catch(e){n(e)}}function s(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Hiburn=t.Burn=void 0;const i=r(1),n=r(4),o=r(6);var s;!function(e){let t,r;e.START_FLAG=new Uint8Array([239,190,173,222]),function(e){e[e.Shake_hands_frame=240]="Shake_hands_frame",e[e.ACK_frame=225]="ACK_frame",e[e.Command_Download_FLASH_image=210]="Command_Download_FLASH_image",e[e.Command_Download_OTP=195]="Command_Download_OTP",e[e.Command_Upload_data=180]="Command_Upload_data",e[e.Command_Read_OTP=165]="Command_Read_OTP",e[e.Command_Flash_Protection=150]="Command_Flash_Protection",e[e.Command_Reset=135]="Command_Reset",e[e.Command_Download_Factory_bin=120]="Command_Download_Factory_bin",e[e.Command_Download_Version=105]="Command_Download_Version",e[e.Command_Download_NVKV_configuration=75]="Command_Download_NVKV_configuration"}(t=e.FrameType||(e.FrameType={})),function(e){e[e.NONE=0]="NONE",e[e.BURN_ACK=1]="BURN_ACK",e[e.YMODEM_START=2]="YMODEM_START",e[e.YMODEM=3]="YMODEM"}(r=e.readMode||(e.readMode={})),e.ACK_FRAME=[239,190,173,222,12,0,225,30,90,66,19,74],e.YMODEM_START_ACK=[67],e.YMODEM_START_ACK_255=[255],e.YMODEM_ACK=[6]}(s=t.Burn||(t.Burn={}));class l{constructor(){this.actionLock=!1,this.readMode=s.readMode.NONE,this.readOkFlag=!0,this.breakFlag=!1,this.actionLock=!1,this.ymodem=new o.Ymodem}static checkSubList(e,t){return!!~t.join("").indexOf(e.join(""))}startReadData(){return a(this,void 0,void 0,(function*(){yield i.webserial.clearData("waffle-nano-burn"),this.readData=setInterval(()=>a(this,void 0,void 0,(function*(){let e=yield i.webserial.onData("waffle-nano-burn");if(e.length>0){let t=[];for(let r of e)t=t.concat(Object.values(r));switch(this.readMode){case s.readMode.NONE:break;case s.readMode.BURN_ACK:l.checkSubList(s.ACK_FRAME,t)&&(this.readOkFlag=!0);break;case s.readMode.YMODEM_START:s.YMODEM_START_ACK[0]===t[0]&&(this.readOkFlag=!0);break;case s.readMode.YMODEM:s.YMODEM_ACK[0]===t[0]&&(this.readOkFlag=!0)}}})),40)}))}stopReadData(){return a(this,void 0,void 0,(function*(){clearInterval(this.readData)}))}crc16_xmodem(e){let t=0;for(let r=0;r<e.byteLength;r++){let a=t>>>8&255;a^=255&e[r],a^=a>>>4,t=t<<8&65535,t^=a,a=a<<5&65535,t^=a,a=a<<7&65535,t^=a}return new Uint8Array([t>>8,255&t])}reverseUint8(e){return(1&e)<<7|(2&e)<<5|(4&e)<<3|(8&e)<<1|(16&e)>>1|(32&e)>>3|(64&e)>>5|(128&e)>>7}frame2Uint8(e){let t=new Uint8Array(e.Data.byteLength+8);t.set(e.Start_flag,0),t.set(e.Packet_size,4),t.set(e.Frame_type,6),t.set(e.Frame_type_reverse,7),t.set(e.Data,8);let r=this.crc16_xmodem(t).reverse(),a=new Uint8Array(t.byteLength+2);return a.set(t,0),a.set(r,t.byteLength),a}generateFrame(e,t){let r=t.byteLength+10,a={Start_flag:s.START_FLAG,Packet_size:new Uint8Array([r>>8,255&r]).reverse(),Frame_type:new Uint8Array([e]),Frame_type_reverse:new Uint8Array([this.reverseUint8(e)]),Data:t};return this.frame2Uint8(a)}sleep(e){return a(this,void 0,void 0,(function*(){return new Promise(t=>setTimeout(t,e))}))}requestUpload(e,t,r){return a(this,void 0,void 0,(function*(){let a=[255&e,e>>8&255,e>>16&255,e>>24&255,255&t,t>>8&255,t>>16&255,t>>24&255,255&r,r>>8&255,r>>16&255,r>>24&255,0,255],n=this.generateFrame(s.FrameType.Command_Download_FLASH_image,new Uint8Array(a));for(this.readOkFlag=!1,this.readMode=s.readMode.YMODEM_START,yield i.webserial.writeListData(Array.from(n));!this.readOkFlag;)yield this.sleep(40)}))}sendReboot(){return a(this,void 0,void 0,(function*(){let e=this.generateFrame(s.FrameType.Command_Reset,new Uint8Array([0,0]));yield i.webserial.writeListData(Array.from(e))}))}sendFile(e){return a(this,void 0,void 0,(function*(){if(!this.breakFlag)for(this.readMode=s.readMode.YMODEM_START,this.readOkFlag=!1;!this.readOkFlag&&!this.breakFlag;)yield this.sleep(40);if(!this.breakFlag){this.readMode=s.readMode.YMODEM;let t=this.ymodem.generateHeader(e.fileName,e.fileSize);for(this.readOkFlag=!1,yield i.webserial.writeListData(Array.from(t));!this.readOkFlag&&!this.breakFlag;)yield this.sleep(40)}let t=this.ymodem.generateBody(e.fileData);for(let e in t){if(i.dialog.processBar.setPercent(Number(e)/t.length),this.breakFlag)break;for(this.readOkFlag=!1,yield i.webserial.writeListData(Array.from(t[e]));!this.readOkFlag&&!this.breakFlag;)yield this.sleep(40)}if(!this.breakFlag){let e=this.ymodem.generateEnd();for(this.readOkFlag=!1,yield i.webserial.writeListData([4]),yield i.webserial.writeListData(Array.from(e));!this.readOkFlag&&!this.breakFlag;)yield this.sleep(40)}}))}startLoader(e){return a(this,void 0,void 0,(function*(){console.log(e);let t=[255&e,e>>8&255,e>>16&255,e>>24&255,8,1,0,0];this.readOkFlag=!1,this.readMode=s.readMode.BURN_ACK;let r=this.generateFrame(s.FrameType.Shake_hands_frame,new Uint8Array(t));for(;!this.readOkFlag&&!this.breakFlag;)yield i.webserial.writeListData(Array.from(r)),yield this.sleep(2);this.readMode=s.readMode.NONE}))}reconnect(e){return a(this,void 0,void 0,(function*(){yield i.webserial.disconnect(),yield this.sleep(1e3),yield i.webserial.openSerialPort({baudRate:e,dataBits:8,stopBits:1,parity:"none",bufferSize:2048,flowControl:"none"})}))}uploadFirmware(e,t){return a(this,void 0,void 0,(function*(){let r=new n.Firmware(e);if(yield r.readFile(),null==r?void 0:r.files){yield this.startReadData();for(let e in r.files){switch(r.files[e].type){case 0:i.dialog.message.open(),i.dialog.message.setContent("Please reboot your waffle"),i.dialog.message.closeButtom(),yield this.startLoader(void 0===t?115200:t),yield this.reconnect(void 0===t?115200:t),i.dialog.message.close(),i.dialog.processBar.open("nyan"),i.dialog.processBar.removeCloseButtom(),i.dialog.processBar.setTitle("Burning");break;case 1:yield this.requestUpload(r.files[e].burnAddr,r.files[e].fileSize,r.files[e].burnSize)}this.breakFlag||(yield this.sendFile(r.files[e]))}i.dialog.processBar.close(),yield this.sendReboot(),yield this.reconnect(115200),yield this.stopReadData()}}))}setBreak(){this.breakFlag||(this.breakFlag=!0)}}t.Hiburn=l},function(e,t,r){"use strict";var a=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))((function(i,n){function o(e){try{l(a.next(e))}catch(e){n(e)}}function s(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Firmware=t.File=void 0;const i=r(5),n=new Uint8Array([223,173,190,239]),o=new TextDecoder,s=32,l=36,d=40,u=44,c=48,f=52;class h{constructor(e,t,r,a,i,n,o){this.fileName=e,this.fileIndex=t,this.fileSize=r,this.burnAddr=a,this.burnSize=i,this.type=n,this.fileData=o}}t.File=h;t.Firmware=class{constructor(e){this._uri=e}readFile(){return a(this,void 0,void 0,(function*(){this.files=[],this._fileData=yield i.FileSystemAdaptor.readFile(this._uri),this._fileSize=yield i.FileSystemAdaptor.getFileSize(this._uri),console.log(this._fileSize),yield this.decodeBin()}))}decodeBuffer2Num(e){let t=0;for(let r=0;r<e.byteLength;r++)t=t<<8|e[r];return t}decodeBin(){var e;return a(this,void 0,void 0,(function*(){if((null==this?void 0:this._fileData)&&(t=this._fileData.subarray(0,4),r=n,t.length===r.length&&t.every((e,t)=>e===r[t]))){this._fileNum=this._fileData[6];for(let t=0;t<this._fileNum;t++){let r=52*t+12,a=o.decode(this._fileData.subarray(r,r+s).filter(e=>0!==e)),i=this.decodeBuffer2Num(this._fileData.subarray(r+s,r+l).reverse()),n=this.decodeBuffer2Num(this._fileData.subarray(r+l,r+d).reverse()),m=this.decodeBuffer2Num(this._fileData.subarray(r+d,r+u).reverse()),_=this.decodeBuffer2Num(this._fileData.subarray(r+u,r+c).reverse()),y=this.decodeBuffer2Num(this._fileData.subarray(r+c,r+f).reverse()),v=this._fileData.subarray(i,i+n),b=new h(a,i,n,m,_,y,v);null===(e=this.files)||void 0===e||e.push(b)}}var t,r}))}}},function(e,t,r){"use strict";var a=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))((function(i,n){function o(e){try{l(a.next(e))}catch(e){n(e)}}function s(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}l((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.FileSystemAdaptor=void 0;const i=r(0);t.FileSystemAdaptor=class{static getFileSize(e,t){var r;return a(this,void 0,void 0,(function*(){return"untitled"===e.scheme?null!==(r=null==t?void 0:t.length)&&void 0!==r?r:0:(yield i.workspace.fs.stat(e)).size}))}static readFile(e,t){return a(this,void 0,void 0,(function*(){return"untitled"===e.scheme?null!=t?t:new Uint8Array:i.workspace.fs.readFile(e)}))}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Ymodem=void 0;const a=1,i=2,n=new TextEncoder;t.Ymodem=class{crc16_xmodem(e){let t=0;for(let r=0;r<e.byteLength;r++){let a=t>>>8&255;a^=255&e[r],a^=a>>>4,t=t<<8&65535,t^=a,a=a<<5&65535,t^=a,a=a<<7&65535,t^=a}return new Uint8Array([t>>8,255&t])}frame2Buffer(e){return new Uint8Array([e.Start,e.PacketNum,e.RPacketNum,...e.Data,...e.Crc])}generateHeader(e,t){let r=n.encode(e),i=n.encode(t.toString()),o=new Uint8Array(128-r.length-i.length-1),s=new Uint8Array([...r,0,...i,...o]),l={Start:a,PacketNum:0,RPacketNum:255,Data:s,Crc:this.crc16_xmodem(s)};return this.frame2Buffer(l)}generateBody(e){let t=[],r=e.length,a=Math.floor(r/1024);for(let r=0;r<a;r++){let a=e.subarray(1024*r,1024*(r+1)),n={Start:i,PacketNum:r+1,RPacketNum:254-r,Data:a,Crc:this.crc16_xmodem(a)};t.push(this.frame2Buffer(n))}let n=e.subarray(1024*a,r),o=new Uint8Array(1024-n.length),s=new Uint8Array([...n,...o]),l={Start:i,PacketNum:a+1,RPacketNum:254-a,Data:s,Crc:this.crc16_xmodem(s)};return t.push(this.frame2Buffer(l)),t}generateEnd(){let e=new Uint8Array(128),t={Start:a,PacketNum:0,RPacketNum:255,Data:e,Crc:this.crc16_xmodem(e)};return this.frame2Buffer(t)}}}]);
//# sourceMappingURL=waffle-nano-burn-frontend.js.map